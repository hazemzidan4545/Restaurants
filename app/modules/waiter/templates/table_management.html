{% extends "shared/base.html" %}

{% block title %}Table Management - Waiter Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="text-gradient">
                    <i class="fas fa-table me-2"></i>Table Management
                </h1>
                <a href="{{ url_for('waiter.dashboard') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Table Statistics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ table_stats.total }}</h4>
                            <p class="mb-0">Total Tables</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-table fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ table_stats.available }}</h4>
                            <p class="mb-0">Available</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ table_stats.occupied }}</h4>
                            <p class="mb-0">Occupied</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ table_stats.reserved }}</h4>
                            <p class="mb-0">Reserved</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tables Grid -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-th-large me-2"></i>Table Layout
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for table in tables %}
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                            <div class="card table-card table-{{ table.status }}" data-table-id="{{ table.table_id }}">
                                <div class="card-body text-center">
                                    <div class="table-icon mb-3">
                                        <i class="fas fa-table fa-3x"></i>
                                    </div>
                                    <h5 class="card-title">{{ table.table_number }}</h5>
                                    <p class="card-text">
                                        <span class="badge bg-{{ 'success' if table.status == 'available' else 'warning' if table.status == 'occupied' else 'info' }} mb-2">
                                            {{ table.status.title() }}
                                        </span>
                                        <br>
                                        <small class="text-muted">Capacity: {{ table.capacity }} people</small>
                                    </p>
                                    
                                    <!-- Active Orders for this table -->
                                    {% set active_orders = table.orders.filter_by(status='new').all() + table.orders.filter_by(status='processing').all() %}
                                    {% if active_orders %}
                                    <div class="active-orders mb-3">
                                        <h6 class="text-muted">Active Orders:</h6>
                                        {% for order in active_orders %}
                                        <div class="small">
                                            <span class="badge bg-{{ 'primary' if order.status == 'new' else 'warning' }}">
                                                #{{ order.order_id }} - {{ order.status.title() }}
                                            </span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Action Buttons -->
                                    <div class="btn-group-vertical w-100">
                                        {% if table.status == 'available' %}
                                        <button class="btn btn-warning btn-sm mb-1" onclick="updateTableStatus({{ table.table_id }}, 'occupied')">
                                            <i class="fas fa-users me-1"></i>Mark Occupied
                                        </button>
                                        <button class="btn btn-info btn-sm" onclick="updateTableStatus({{ table.table_id }}, 'reserved')">
                                            <i class="fas fa-calendar me-1"></i>Reserve
                                        </button>
                                        {% elif table.status == 'occupied' %}
                                        <button class="btn btn-success btn-sm mb-1" onclick="updateTableStatus({{ table.table_id }}, 'available')">
                                            <i class="fas fa-check me-1"></i>Mark Available
                                        </button>
                                        <button class="btn btn-info btn-sm" onclick="updateTableStatus({{ table.table_id }}, 'reserved')">
                                            <i class="fas fa-calendar me-1"></i>Reserve
                                        </button>
                                        {% elif table.status == 'reserved' %}
                                        <button class="btn btn-warning btn-sm mb-1" onclick="updateTableStatus({{ table.table_id }}, 'occupied')">
                                            <i class="fas fa-users me-1"></i>Mark Occupied
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="updateTableStatus({{ table.table_id }}, 'available')">
                                            <i class="fas fa-check me-1"></i>Mark Available
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.table-card {
    transition: all 0.3s ease;
    border: 2px solid;
}

.table-available {
    border-color: #28a745;
    background-color: #f8fff9;
}

.table-occupied {
    border-color: #ffc107;
    background-color: #fffdf5;
}

.table-reserved {
    border-color: #17a2b8;
    background-color: #f5fdff;
}

.table-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.table-icon {
    color: #6c757d;
}

.table-available .table-icon {
    color: #28a745;
}

.table-occupied .table-icon {
    color: #ffc107;
}

.table-reserved .table-icon {
    color: #17a2b8;
}

.active-orders {
    border-top: 1px solid #dee2e6;
    padding-top: 10px;
}
</style>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
function updateTableStatus(tableId, status) {
    fetch('{{ url_for("waiter.update_table_status") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
        },
        body: JSON.stringify({
            table_id: tableId,
            status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            RestaurantApp.showNotification('Success', data.message, 'success');
            
            // Update the UI
            const tableCard = document.querySelector(`[data-table-id="${tableId}"]`);
            if (tableCard) {
                // Update card classes
                tableCard.className = tableCard.className.replace(/table-\w+/g, '');
                tableCard.classList.add(`table-${status}`);
                
                // Update status badge
                const statusBadge = tableCard.querySelector('.badge');
                statusBadge.className = `badge bg-${status === 'available' ? 'success' : status === 'occupied' ? 'warning' : 'info'} mb-2`;
                statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                
                // Update action buttons
                const buttonContainer = tableCard.querySelector('.btn-group-vertical');
                let buttonsHtml = '';
                
                if (status === 'available') {
                    buttonsHtml = `
                        <button class="btn btn-warning btn-sm mb-1" onclick="updateTableStatus(${tableId}, 'occupied')">
                            <i class="fas fa-users me-1"></i>Mark Occupied
                        </button>
                        <button class="btn btn-info btn-sm" onclick="updateTableStatus(${tableId}, 'reserved')">
                            <i class="fas fa-calendar me-1"></i>Reserve
                        </button>
                    `;
                } else if (status === 'occupied') {
                    buttonsHtml = `
                        <button class="btn btn-success btn-sm mb-1" onclick="updateTableStatus(${tableId}, 'available')">
                            <i class="fas fa-check me-1"></i>Mark Available
                        </button>
                        <button class="btn btn-info btn-sm" onclick="updateTableStatus(${tableId}, 'reserved')">
                            <i class="fas fa-calendar me-1"></i>Reserve
                        </button>
                    `;
                } else if (status === 'reserved') {
                    buttonsHtml = `
                        <button class="btn btn-warning btn-sm mb-1" onclick="updateTableStatus(${tableId}, 'occupied')">
                            <i class="fas fa-users me-1"></i>Mark Occupied
                        </button>
                        <button class="btn btn-success btn-sm" onclick="updateTableStatus(${tableId}, 'available')">
                            <i class="fas fa-check me-1"></i>Mark Available
                        </button>
                    `;
                }
                
                buttonContainer.innerHTML = buttonsHtml;
            }
        } else {
            RestaurantApp.showNotification('Error', data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        RestaurantApp.showNotification('Error', 'Failed to update table status', 'error');
    });
}
</script>
{% endblock %}
