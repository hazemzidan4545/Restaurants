{% extends "./base.html" %}

{% block title %}Edit Menu Item - Admin Dashboard{% endblock %}
{% block page_title %}Edit Menu Item{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<!-- Enhanced Page Header -->
<div class="page-header">
    <div class="header-background">
        <div class="header-pattern"></div>
        <div class="header-gradient"></div>
    </div>
    <div class="header-content">
        <div class="header-icon-container">
            <div class="header-icon">
                <i class="fas fa-edit"></i>
            </div>
        </div>
        <div class="header-text">
            <h1 class="page-title">Edit Menu Item</h1>
            <p class="page-description">
                <i class="fas fa-info-circle"></i>
                Modify menu item details, pricing, and availability settings
            </p>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-number">{{ menu_item.name if menu_item else 'Item' }}</span>
                    <span class="stat-label">Editing</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ menu_item.category.name if menu_item and menu_item.category else 'N/A' }}</span>
                    <span class="stat-label">Category</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${{ "%.2f"|format(menu_item.price if menu_item else 0) }}</span>
                    <span class="stat-label">Price</span>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('admin.menu_management') }}" class="header-btn header-btn-secondary">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Menu</span>
            </a>
            <button type="submit" form="editMenuItemForm" class="header-btn header-btn-primary">
                <i class="fas fa-save"></i>
                <span>Save Changes</span>
            </button>
        </div>
    </div>
</div>

<!-- Form Section -->
<div class="row justify-content-center">
    <div class="col-md-12 col-lg-10">
        <div class="admin-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-utensils"></i>
                    Edit Menu Item: {{ menu_item.name }}
                </h3>
                <div class="form-progress">
                    <div class="progress-bar" id="formProgress"></div>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="editMenuItemForm" novalidate>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <!-- Basic Information Section -->
                    <div class="form-section mb-4">
                        <h4 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Basic Information
                        </h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">
                                        <i class="fas fa-tag me-1"></i>Item Name <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="name" name="name" required
                                           value="{{ menu_item.name }}" placeholder="e.g., Grilled Chicken, Fresh Orange Juice"
                                           data-validation="required|min:2|max:100">
                                    <div class="invalid-feedback"></div>
                                    <div class="form-text">Enter a descriptive name for your menu item</div>
                                </div>

                                <div class="mb-3">
                                    <label for="category_id" class="form-label">
                                        <i class="fas fa-folder me-1"></i>Category <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <select class="form-select" id="category_id" name="category_id" required
                                                data-validation="required">
                                            <option value="">Select a category</option>
                                            {% for category in categories %}
                                            <option value="{{ category.category_id }}"
                                                    {% if category.category_id == menu_item.category_id %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary" id="addCategoryBtn"
                                                title="Add New Category">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                    <div class="form-text">Choose the appropriate category for this item</div>
                                </div>

                                <div class="mb-3">
                                    <label for="price" class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>Price (EGP) <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">EGP</span>
                                        <input type="number" class="form-control" id="price" name="price"
                                               step="0.01" min="0.01" required value="{{ menu_item.price }}" placeholder="0.00"
                                               data-validation="required|min:0.01|max:9999.99">
                                        <button type="button" class="btn btn-outline-info" id="priceCalculator"
                                                title="Price Calculator">
                                            <i class="fas fa-calculator"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                    <div class="form-text">Set the selling price for this item</div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="stock" class="form-label">
                                        <i class="fas fa-boxes me-1"></i>Stock Quantity
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="stock" name="stock"
                                               min="0" value="{{ menu_item.stock }}" placeholder="0"
                                               data-validation="min:0|max:99999">
                                        <div class="input-group-text">
                                            <input class="form-check-input" type="checkbox" id="unlimitedStock"
                                                   {% if menu_item.stock == 0 %}checked{% endif %}>
                                            <label class="form-check-label ms-1" for="unlimitedStock">Unlimited</label>
                                        </div>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                    <div class="form-text">Current stock quantity (0 for unlimited)</div>
                                </div>

                                <div class="mb-3">
                                    <label for="status" class="form-label">
                                        <i class="fas fa-toggle-on me-1"></i>Status
                                    </label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="available" {% if menu_item.status == 'available' %}selected{% endif %}>Available</option>
                                        <option value="out_of_stock" {% if menu_item.status == 'out_of_stock' %}selected{% endif %}>Out of Stock</option>
                                        <option value="discontinued" {% if menu_item.status == 'discontinued' %}selected{% endif %}>Discontinued</option>
                                    </select>
                                    <div class="form-text">Set the availability status</div>
                                </div>

                                <div class="mb-3">
                                    <label for="preparation_time" class="form-label">
                                        <i class="fas fa-clock me-1"></i>Preparation Time (minutes)
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="preparation_time"
                                               name="preparation_time" min="1" max="180"
                                               value="{{ menu_item.preparation_time or '' }}" placeholder="15"
                                               data-validation="min:1|max:180">
                                        <span class="input-group-text">min</span>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                    <div class="form-text">Estimated preparation time</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Description & Details Section -->
                    <div class="form-section mb-4">
                        <h4 class="section-title">
                            <i class="fas fa-align-left"></i>
                            Description & Details
                        </h4>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="description" class="form-label">
                                        <i class="fas fa-file-alt me-1"></i>Description
                                    </label>
                                    <textarea class="form-control" id="description" name="description" rows="4"
                                              placeholder="Describe the item, ingredients, preparation method, allergens, etc."
                                              data-validation="max:500">{{ menu_item.description or '' }}</textarea>
                                    <div class="invalid-feedback"></div>
                                    <div class="form-text">
                                        <span id="descriptionCount">{{ (menu_item.description or '')|length }}</span>/500 characters
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="ingredients" class="form-label">
                                        <i class="fas fa-list me-1"></i>Ingredients
                                    </label>
                                    <textarea class="form-control" id="ingredients" name="ingredients" rows="3"
                                              placeholder="List main ingredients separated by commas"
                                              data-validation="max:300">{{ menu_item.ingredients or '' }}</textarea>
                                    <div class="invalid-feedback"></div>
                                    <div class="form-text">
                                        <span id="ingredientsCount">{{ (menu_item.ingredients or '')|length }}</span>/300 characters
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="allergens" class="form-label">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Allergens
                                            </label>
                                            <input type="text" class="form-control" id="allergens" name="allergens"
                                                   value="{{ menu_item.allergens or '' }}" placeholder="e.g., Nuts, Dairy, Gluten"
                                                   data-validation="max:100">
                                            <div class="invalid-feedback"></div>
                                            <div class="form-text">Common allergens present</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="calories" class="form-label">
                                                <i class="fas fa-fire me-1"></i>Calories (per serving)
                                            </label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="calories" name="calories"
                                                       min="0" max="9999" value="{{ menu_item.calories or '' }}" placeholder="250"
                                                       data-validation="min:0|max:9999">
                                                <span class="input-group-text">kcal</span>
                                            </div>
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="image" class="form-label">
                                        <i class="fas fa-image me-1"></i>Item Image
                                    </label>
                                    <div class="image-upload-area" id="imageUploadArea">
                                        <input type="file" class="form-control d-none" id="image" name="image"
                                               accept="image/png,image/jpg,image/jpeg,image/gif,image/webp"
                                               data-validation="file|max-size:16MB">

                                        <!-- Current Image Display -->
                                        {% if menu_item.image_url %}
                                        <div class="current-image" id="currentImageDisplay">
                                            <img src="{{ url_for('static', filename='uploads/menu_images/' + menu_item.image_url) }}"
                                                 alt="{{ menu_item.name }}" class="preview-image" id="currentImg"
                                                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'upload-placeholder\' id=\'uploadPlaceholder\'><i class=\'fas fa-image fa-3x mb-3 text-muted\'></i><p class=\'mb-2 text-muted\'>Image not found</p><p class=\'text-muted small\'>Click to upload new image</p></div>';">
                                            <div class="image-overlay">
                                                <button type="button" class="btn btn-sm btn-outline-light" id="changeCurrentImage">
                                                    <i class="fas fa-edit me-1"></i>Change
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" id="removeCurrentImage">
                                                    <i class="fas fa-trash me-1"></i>Remove
                                                </button>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="upload-placeholder" id="uploadPlaceholder">
                                            <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                                            <p class="mb-2">Click to upload image</p>
                                            <p class="text-muted small">PNG, JPG, JPEG, GIF, WebP</p>
                                            <p class="text-muted small">Max size: 16MB</p>
                                        </div>
                                        {% endif %}

                                        <div class="image-preview" id="imagePreview" style="display: none;">
                                            <img id="previewImg" src="" alt="Preview" class="preview-image">
                                            <div class="image-overlay">
                                                <button type="button" class="btn btn-sm btn-outline-light" id="changeImage">
                                                    <i class="fas fa-edit me-1"></i>Change
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" id="removeImage">
                                                    <i class="fas fa-trash me-1"></i>Remove
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                    <div class="form-text">Upload a new image to replace the current one</div>
                                </div>

                                <!-- Additional Options -->
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-star me-1"></i>Special Options
                                    </label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured"
                                               {% if menu_item.is_featured %}checked{% endif %}>
                                        <label class="form-check-label" for="is_featured">
                                            Featured Item
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_spicy" name="is_spicy"
                                               {% if menu_item.is_spicy %}checked{% endif %}>
                                        <label class="form-check-label" for="is_spicy">
                                            Spicy
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_vegetarian" name="is_vegetarian"
                                               {% if menu_item.is_vegetarian %}checked{% endif %}>
                                        <label class="form-check-label" for="is_vegetarian">
                                            Vegetarian
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_vegan" name="is_vegan"
                                               {% if menu_item.is_vegan %}checked{% endif %}>
                                        <label class="form-check-label" for="is_vegan">
                                            Vegan
                                        </label>
                                    </div>
                                </div>

                                <!-- Enhanced Item Statistics -->
                                <div class="mb-3">
                                    <div class="stats-card enhanced-stats-card">
                                        <div class="stats-header">
                                            <div class="stats-icon-wrapper">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                            <h6 class="stats-title">
                                                Item Statistics
                                            </h6>
                                            <div class="stats-badge">
                                                <i class="fas fa-info-circle"></i>
                                            </div>
                                        </div>
                                        <div class="stats-grid enhanced-stats-grid">
                                            <div class="stat-item enhanced-stat-item">
                                                <div class="stat-icon created-icon">
                                                    <i class="fas fa-calendar-plus"></i>
                                                </div>
                                                <div class="stat-content">
                                                    <span class="stat-label">Created:</span>
                                                    <span class="stat-value created-date">{{ menu_item.created_at.strftime('%Y-%m-%d') }}</span>
                                                </div>
                                            </div>
                                            <div class="stat-item enhanced-stat-item">
                                                <div class="stat-icon updated-icon">
                                                    <i class="fas fa-calendar-plus"></i>
                                                </div>
                                                <div class="stat-content">
                                                    <span class="stat-label">Updated:</span>
                                                    <span class="stat-value updated-date">{{ menu_item.updated_at.strftime('%Y-%m-%d') }}</span>
                                                </div>
                                            </div>
                                            <div class="stat-item enhanced-stat-item">
                                                <div class="stat-icon stock-icon">
                                                    <i class="fas fa-boxes"></i>
                                                </div>
                                                <div class="stat-content">
                                                    <span class="stat-label">Current Stock:</span>
                                                    <span class="stat-value stock-value {% if menu_item.stock and menu_item.stock > 0 %}in-stock{% else %}unlimited{% endif %}">
                                                        {{ menu_item.stock if menu_item.stock and menu_item.stock > 0 else 'Unlimited' }}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="stat-item enhanced-stat-item">
                                                <div class="stat-icon status-icon">
                                                    <i class="fas fa-toggle-on"></i>
                                                </div>
                                                <div class="stat-content">
                                                    <span class="stat-label">Status:</span>
                                                    <span class="status-badge status-{{ menu_item.status }}" style="font-weight: bold;">
                                                        {% if menu_item.status == 'available' %}
                                                            <i class="fas fa-check-circle me-1"></i>Available
                                                        {% elif menu_item.status == 'out_of_stock' %}
                                                            <i class="fas fa-exclamation-triangle me-1"></i>Out of Stock
                                                        {% else %}
                                                            <i class="fas fa-times-circle me-1"></i>{{ menu_item.status|title }}
                                                        {% endif %}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Form Actions -->
                    <div class="form-actions enhanced-form-actions">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-summary enhanced-form-summary">
                                    <div class="summary-header">
                                        <div class="summary-icon">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <h6 class="summary-title">Form Completion</h6>
                                    </div>
                                    <div class="progress enhanced-progress mb-3">
                                        <div class="progress-bar enhanced-progress-bar" id="completionProgress" 
                                             style="width: 85%" role="progressbar" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100">
                                            <span class="progress-text">85%</span>
                                        </div>
                                    </div>
                                    <div class="completion-status">
                                        <div class="status-indicator ready">
                                            <i class="fas fa-check me-2"></i>
                                            <span id="completionText">Ready to update!</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="action-buttons-container">
                                    <div class="action-buttons enhanced-action-buttons">
                                        <button type="button" class="btn btn-outline-info enhanced-preview-btn" id="previewBtn">
                                            <div class="btn-icon">
                                                <i class="fas fa-eye"></i>
                                            </div>
                                            <span class="btn-text">Preview</span>
                                            <div class="btn-shine"></div>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger enhanced-delete-btn" id="deleteBtn">
                                            <div class="btn-icon">
                                                <i class="fas fa-trash"></i>
                                            </div>
                                            <span class="btn-text">Delete</span>
                                            <div class="btn-shine"></div>
                                        </button>
                                        <a href="{{ url_for('admin.menu_management') }}" class="btn btn-secondary enhanced-cancel-btn">
                                            <div class="btn-icon">
                                                <i class="fas fa-times"></i>
                                            </div>
                                            <span class="btn-text">Cancel</span>
                                            <div class="btn-shine"></div>
                                        </a>
                                        <button type="submit" class="btn btn-primary enhanced-submit-btn" id="submitBtn">
                                            <span class="spinner-border spinner-border-sm d-none me-2" id="submitSpinner"></span>
                                            <div class="btn-icon" id="submitIcon">
                                                <i class="fas fa-save"></i>
                                            </div>
                                            <span class="btn-text" id="submitText">Update Menu Item</span>
                                            <div class="btn-shine"></div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade bottom-modal" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content preview-modal">
            <div class="modal-header preview-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Menu Item Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModal('previewModal')"></button>
            </div>
            <div class="modal-body preview-body">
                <div class="preview-container">
                    <div class="preview-image-section">
                        <div class="preview-image-container">
                            <img id="previewImage" src="" alt="Menu Item" class="preview-image">
                        </div>
                    </div>
                    <div class="preview-details-section">
                        <div class="preview-header-info">
                            <h2 id="previewName" class="preview-title"></h2>
                            <div class="preview-category-badge">
                                <i class="fas fa-tag me-1"></i>
                                <span id="previewCategory"></span>
                            </div>
                        </div>
                        
                        <div class="preview-price-section">
                            <span id="previewPrice" class="preview-price"></span>
                        </div>

                        <div class="preview-description-box">
                            <p id="previewDescription" class="preview-description"></p>
                        </div>

                        <div class="preview-info-grid">
                            <div class="info-item">
                                <i class="fas fa-box"></i>
                                <div class="info-content">
                                    <label>Stock</label>
                                    <span id="previewStock"></span>
                                </div>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <div class="info-content">
                                    <label>Prep Time</label>
                                    <span id="previewPrepTime"></span>
                                </div>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-fire"></i>
                                <div class="info-content">
                                    <label>Calories</label>
                                    <span id="previewCalories"></span>
                                </div>
                            </div>
                        </div>

                        <div class="preview-details-box">
                            <div class="details-section">
                                <h3><i class="fas fa-leaf me-2"></i>Ingredients</h3>
                                <p id="previewIngredients"></p>
                            </div>
                            <div class="details-section">
                                <h3><i class="fas fa-exclamation-triangle me-2"></i>Allergens</h3>
                                <p id="previewAllergens"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer preview-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('previewModal')">Close Preview</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade bottom-modal" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content enhanced-delete-modal">
            <div class="modal-header enhanced-delete-header">
                <div class="delete-header-content">
                    <div class="danger-icon-wrapper animated-pulse">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="delete-title-container">
                        <h5 class="modal-title text-white enhanced-delete-title">Confirm Delete</h5>
                        <p class="delete-subtitle">You are about to delete this item</p>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="closeModal('deleteModal')"></button>
            </div>
            <div class="modal-body enhanced-delete-body">
                <div class="delete-confirmation-content">
                    <div class="delete-item-info">
                        <div class="item-preview">
                            <div class="item-icon">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div class="item-details">
                                <h6 class="item-name">{{ menu_item.name }}</h6>
                                <p class="item-category text-muted">{{ menu_item.category.name if menu_item.category else 'No Category' }}</p>
                            </div>
                        </div>
                    </div>
                    <p class="delete-question">Are you sure you want to delete this menu item?</p>
                    <div class="alert alert-danger enhanced-warning">
                        <div class="warning-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="warning-content">
                            <strong>Warning:</strong> This action cannot be undone. All data associated with this menu item will be permanently deleted.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer enhanced-delete-footer">
                <button type="button" class="btn btn-secondary enhanced-cancel-btn" onclick="closeModal('deleteModal')">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <form method="POST" action="{{ url_for('admin.delete_menu_item', item_id=menu_item.item_id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger enhanced-delete-btn">
                        <i class="fas fa-trash me-2"></i>Delete Item
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade bottom-modal" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add New Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModal('addCategoryModal')"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="mb-3">
                        <label for="newCategoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="newCategoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="newCategoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="newCategoryDescription" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addCategoryModal')">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCategoryBtn" onclick="saveCategory()">
                    <i class="fas fa-save me-2"></i>Add Category
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Force sidebar to be fixed on edit menu item page */
.admin-sidebar {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 260px !important;
    height: 100vh !important;
    z-index: 1000 !important;
    background: linear-gradient(180deg, #000000 0%, #0a0a0a 50%, #000000 100%) !important;
    transform: translateX(0) !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Ensure main content has proper offset */
.main-content {
    margin-left: 260px !important;
    position: relative !important;
    min-height: 100vh !important;
}

/* Optimized CSS for better performance */
html {
    scroll-behavior: auto; /* We'll handle smooth scrolling with JS */
    height: 100%;
}

body {
    overflow-y: auto;
    height: 100%;
    /* Use hardware acceleration for smoother scrolling */
    transform: translateZ(0);
    will-change: scroll-position;
    -webkit-font-smoothing: antialiased;
}

.modal-open {
    overflow: hidden;
}

.modal {
    overflow-y: auto;
    /* Use hardware acceleration for modals */
    transform: translateZ(0);
    will-change: transform, opacity;
    backface-visibility: hidden;
}

.modal-dialog {
    margin: 1.75rem auto;
    transition: transform 0.3s cubic-bezier(0.215, 0.610, 0.355, 1.000);
    will-change: transform;
}

/* Optimize animations for better performance */
@keyframes slideUp {
    from {
        transform: translateY(100px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes slideDown {
    from {
        transform: translateY(0);
        opacity: 1;
    }
    to {
        transform: translateY(100px);
        opacity: 0;
    }
}

/* Use hardware acceleration for animations */
.modal-content, .modal-dialog, .btn-shine {
    transform: translateZ(0);
    will-change: transform, opacity;
    backface-visibility: hidden;
}

/* Optimize form transitions */
.form-control, .form-select {
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

/* Optimize progress bar animation */
.progress-bar {
    transition: width 0.3s cubic-bezier(0.215, 0.610, 0.355, 1.000);
    will-change: width;
}

/* Optimize button hover effects */
.enhanced-action-buttons .btn {
    transition: transform 0.2s cubic-bezier(0.215, 0.610, 0.355, 1.000), 
                box-shadow 0.2s cubic-bezier(0.215, 0.610, 0.355, 1.000),
                background-color 0.2s ease;
}

/* Optimize image hover effects */
.image-overlay {
    transition: opacity 0.2s ease;
}

/* Optimize modal animations */
.modal.fade .modal-dialog {
    transform: translate(0, -30px);
    transition: transform 0.3s cubic-bezier(0.215, 0.610, 0.355, 1.000);
    will-change: transform;
}

.modal.show .modal-dialog {
    transform: translate(0, 0);
}

/* Optimize bottom modal animations */
.modal.bottom-modal .modal-dialog {
    transform: translate(0, 100%);
    transition: transform 0.3s cubic-bezier(0.215, 0.610, 0.355, 1.000);
    will-change: transform;
}

.modal.bottom-modal.show .modal-dialog {
    transform: translate(0, 0);
}

/* Reduce paint operations by using opacity for transitions */
.btn-shine {
    transition: left 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000);
    will-change: left;
}

/* Keep the rest of the styles but optimize animations */
/* ... existing styles ... */

/* Critical Z-index Fix - Optimized */
.modal {
    z-index: 1050 !important;
}

.modal-backdrop {
    z-index: 1040 !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
    opacity: 0.5 !important;
}

.modal-dialog {
    z-index: 1060 !important;
    max-width: 90% !important;
    margin: 0.5rem auto !important;
}

.modal-content {
    z-index: 1070 !important;
    max-height: 80vh !important;
    overflow-y: auto !important;
}

/* Size adjustments - Optimized */
@media (min-width: 768px) {
    .modal-dialog {
        max-width: 600px !important;
    }
    
    .modal-dialog.modal-lg {
        max-width: 800px !important;
    }
}

/* Force pointer events - Optimized */
.modal-content * {
    pointer-events: auto !important;
}

/* Ensure buttons are clickable - Optimized */
.modal button,
.modal .btn,
.modal a,
.modal input[type="submit"] {
    position: relative !important;
    z-index: 1080 !important;
    pointer-events: auto !important;
}

/* Fix modal body size - Optimized */
.preview-body {
    max-height: 60vh !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
}

/* Make preview container more compact - Optimized */
.preview-container {
    display: flex;
    flex-direction: column;
}

.preview-image-section {
    height: 200px !important;
}

.preview-details-section {
    padding: 1rem !important;
}

.preview-info-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem !important;
}

.info-item {
    padding: 0.5rem !important;
}

.preview-description-box {
    padding: 0.75rem !important;
    margin-bottom: 0.75rem !important;
}

.preview-details-box {
    padding: 0.75rem !important;
}

.details-section {
    margin-bottom: 0.75rem !important;
}

/* Make delete modal more compact - Optimized */
.enhanced-delete-body {
    padding: 1rem !important;
}

.delete-item-info {
    padding: 1rem !important;
    margin-bottom: 1rem !important;
}

.delete-question {
    margin: 1rem 0 !important;
}

/* Extreme z-index override - Optimized */
#previewModal, #deleteModal, #addCategoryModal {
    z-index: 9999 !important;
}

/* The rest of the CSS remains the same */
</style>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced Edit Menu Item JavaScript - Optimized for Performance
document.addEventListener('DOMContentLoaded', function() {
    // Cache DOM elements to avoid repeated lookups
    const previewModalEl = document.getElementById('previewModal');
    const deleteModalEl = document.getElementById('deleteModal');
    const addCategoryModalEl = document.getElementById('addCategoryModal');
    const formEl = document.getElementById('editMenuItemForm');
    const progressBarEl = document.getElementById('completionProgress');
    const progressTextEl = document.querySelector('.progress-text');
    const completionTextEl = document.getElementById('completionText');
    
    // Enable hardware-accelerated smooth scrolling
    document.documentElement.style.scrollBehavior = 'auto'; // We'll handle smooth scrolling manually
    
    // Remove existing backdrops for cleaner initialization
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    
    // Initialize modals with optimized settings
    const previewModal = new bootstrap.Modal(previewModalEl, {
        backdrop: false // Disable built-in backdrop for better performance
    });
    
    const deleteModal = new bootstrap.Modal(deleteModalEl, {
        backdrop: false
    });
    
    const addCategoryModal = new bootstrap.Modal(addCategoryModalEl, {
        backdrop: false
    });
    
    // Store modals in window object for global access with minimal overhead
    window.modals = { previewModal, deleteModal, addCategoryModal };
    
    // Use passive event listeners for better scroll performance
    previewModalEl.addEventListener('shown.bs.modal', function() {
        requestAnimationFrame(() => smoothScrollToModal('previewModal'));
    }, { passive: true });
    
    deleteModalEl.addEventListener('shown.bs.modal', function() {
        requestAnimationFrame(() => smoothScrollToModal('deleteModal'));
    }, { passive: true });
    
    addCategoryModalEl.addEventListener('shown.bs.modal', function() {
        requestAnimationFrame(() => smoothScrollToModal('addCategoryModal'));
    }, { passive: true });
    
    // Set up optimized event listeners for buttons - use event delegation where possible
    document.getElementById('previewBtn').addEventListener('click', function(e) {
        e.preventDefault();
        showPreview();
    }, { passive: false });
    
    document.getElementById('deleteBtn').addEventListener('click', function(e) {
        e.preventDefault();
        showDelete();
    }, { passive: false });
    
    document.getElementById('addCategoryBtn').addEventListener('click', function(e) {
        e.preventDefault();
        showAddCategory();
    }, { passive: false });
    
    // Fix all close buttons with event delegation
    document.body.addEventListener('click', function(e) {
        if (e.target.hasAttribute('data-bs-dismiss') || e.target.closest('[data-bs-dismiss="modal"]')) {
            e.preventDefault();
            const modalEl = e.target.closest('.modal');
            if (modalEl) closeModal(modalEl.id);
        }
    }, { passive: false });
    
    // Initialize progress bar
    updateProgress();
    
    // Set up event listeners for form fields with debounce
    if (formEl) {
        const formFields = formEl.querySelectorAll('input, select, textarea');
        formFields.forEach(field => {
            field.addEventListener('change', debounce(updateProgress, 200), { passive: true });
            field.addEventListener('input', debounce(updateProgress, 300), { passive: true });
        });
    }
    
    // Description counter with optimized updates
    const description = document.getElementById('description');
    const descriptionCount = document.getElementById('descriptionCount');
    if (description && descriptionCount) {
        description.addEventListener('input', debounce(function() {
            descriptionCount.textContent = description.value.length;
        }, 100), { passive: true });
    }
    
    // Ingredients counter with optimized updates
    const ingredients = document.getElementById('ingredients');
    const ingredientsCount = document.getElementById('ingredientsCount');
    if (ingredients && ingredientsCount) {
        ingredients.addEventListener('input', debounce(function() {
            ingredientsCount.textContent = ingredients.value.length;
        }, 100), { passive: true });
    }
    
    // Unlimited stock checkbox with optimized handling
    const unlimitedStock = document.getElementById('unlimitedStock');
    const stock = document.getElementById('stock');
    if (unlimitedStock && stock) {
        unlimitedStock.addEventListener('change', function() {
            stock.disabled = unlimitedStock.checked;
            if (unlimitedStock.checked) {
                stock.value = '0';
            }
            requestAnimationFrame(updateProgress);
        }, { passive: true });
    }
    
    // Image upload with optimized handlers
    initializeImageUpload();
});

// Debounce function for performance optimization
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

// Throttle function for performance-critical operations
function throttle(func, limit) {
    let inThrottle;
    return function(...args) {
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

// Initialize image upload with optimized handlers
function initializeImageUpload() {
    const imageInput = document.getElementById('image');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const currentImageDisplay = document.getElementById('currentImageDisplay');
    const imageUploadArea = document.getElementById('imageUploadArea');
    
    // Use event delegation where possible
    if (uploadPlaceholder) {
        uploadPlaceholder.addEventListener('click', () => imageInput.click(), { passive: true });
    }
    
    if (imageUploadArea && !uploadPlaceholder) {
        imageUploadArea.addEventListener('click', () => imageInput.click(), { passive: true });
    }
    
    if (imageInput) {
        imageInput.addEventListener('change', handleImageChange, { passive: true });
    }
    
    // Optimize event handlers for image controls
    const changeCurrentImage = document.getElementById('changeCurrentImage');
    if (changeCurrentImage) {
        changeCurrentImage.addEventListener('click', (e) => {
            e.stopPropagation();
            imageInput.click();
        }, { passive: true });
    }
    
    const removeCurrentImage = document.getElementById('removeCurrentImage');
    if (removeCurrentImage) {
        removeCurrentImage.addEventListener('click', (e) => {
            e.stopPropagation();
            removeImage();
        }, { passive: true });
    }
    
    const changeImage = document.getElementById('changeImage');
    if (changeImage) {
        changeImage.addEventListener('click', (e) => {
            e.stopPropagation();
            imageInput.click();
        }, { passive: true });
    }
    
    const removeImage = document.getElementById('removeImage');
    if (removeImage) {
        removeImage.addEventListener('click', (e) => {
            e.stopPropagation();
            removeImagePreview();
        }, { passive: true });
    }
}

// Add drag and drop functionality for image upload
document.addEventListener('DOMContentLoaded', function() {
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imageInput = document.getElementById('image');
    
    if (imageUploadArea && imageInput) {
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            imageUploadArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop area when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            imageUploadArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            imageUploadArea.addEventListener(eventName, unhighlight, false);
        });
        
        // Handle dropped files
        imageUploadArea.addEventListener('drop', handleDrop, false);
    }
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight(e) {
        imageUploadArea.classList.add('dragover');
    }
    
    function unhighlight(e) {
        imageUploadArea.classList.remove('dragover');
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            imageInput.files = files;
            handleImageChange({ target: { files: files } });
        }
    }
});

// Handle image file selection and preview
function handleImageChange(event) {
    const file = event.target.files[0];
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const currentImageDisplay = document.getElementById('currentImageDisplay');
    
    if (file) {
        // Validate file type
        const validTypes = ['image/png', 'image/jpg', 'image/jpeg', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            alert('Please select a valid image file (PNG, JPG, JPEG, GIF, WebP)');
            event.target.value = '';
            return;
        }
        
        // Validate file size (16MB max)
        if (file.size > 16 * 1024 * 1024) {
            alert('File size must be less than 16MB');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            if (previewImg) {
                previewImg.src = e.target.result;
                previewImg.alt = file.name;
            }
            
            // Show preview and hide other elements
            if (imagePreview) imagePreview.style.display = 'block';
            if (uploadPlaceholder) uploadPlaceholder.style.display = 'none';
            if (currentImageDisplay) currentImageDisplay.style.display = 'none';
            
            updateProgress();
        };
        reader.readAsDataURL(file);
    }
}

// Remove image preview and show upload placeholder
function removeImagePreview() {
    const imageInput = document.getElementById('image');
    const imagePreview = document.getElementById('imagePreview');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const currentImageDisplay = document.getElementById('currentImageDisplay');
    
    if (imageInput) imageInput.value = '';
    if (imagePreview) imagePreview.style.display = 'none';
    
    // Show appropriate placeholder
    if (currentImageDisplay) {
        currentImageDisplay.style.display = 'block';
    } else if (uploadPlaceholder) {
        uploadPlaceholder.style.display = 'flex';
    }
    
    updateProgress();
}

// Remove current image (existing image)
function removeImage() {
    const currentImageDisplay = document.getElementById('currentImageDisplay');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const imageInput = document.getElementById('image');
    
    if (currentImageDisplay) currentImageDisplay.style.display = 'none';
    if (uploadPlaceholder) uploadPlaceholder.style.display = 'flex';
    if (imageInput) imageInput.value = '';
    
    // Add a hidden input to indicate image removal
    let removeInput = document.getElementById('remove_image');
    if (!removeInput) {
        removeInput = document.createElement('input');
        removeInput.type = 'hidden';
        removeInput.name = 'remove_image';
        removeInput.id = 'remove_image';
        removeInput.value = '1';
        document.getElementById('editMenuItemForm').appendChild(removeInput);
    } else {
        removeInput.value = '1';
    }
    
    updateProgress();
}

// Update progress bar and completion status
function updateProgress() {
    const form = document.getElementById('editMenuItemForm');
    if (!form) return;
    
    const progressBar = document.getElementById('completionProgress');
    const progressText = progressBar ? progressBar.querySelector('.progress-text') : null;
    const completionText = document.getElementById('completionText');
    const statusIndicator = document.querySelector('.status-indicator');
    
    // Get required fields
    const requiredFields = form.querySelectorAll('[required]');
    let completedFields = 0;
    let totalFields = requiredFields.length;
    
    // Check each required field
    requiredFields.forEach(field => {
        if (field.type === 'checkbox' || field.type === 'radio') {
            if (field.checked) completedFields++;
        } else if (field.tagName === 'SELECT') {
            if (field.value && field.value !== '') completedFields++;
        } else {
            if (field.value && field.value.trim() !== '') completedFields++;
        }
    });
    
    // Calculate percentage
    const percentage = Math.round((completedFields / totalFields) * 100);
    
    // Update progress bar
    if (progressBar) {
        progressBar.style.width = percentage + '%';
        progressBar.setAttribute('aria-valuenow', percentage);
    }
    
    if (progressText) {
        progressText.textContent = percentage + '%';
    }
    
    // Update status
    if (completionText && statusIndicator) {
        if (percentage >= 100) {
            completionText.textContent = 'Ready to update!';
            statusIndicator.className = 'status-indicator ready';
        } else if (percentage >= 80) {
            completionText.textContent = 'Almost complete!';
            statusIndicator.className = 'status-indicator ready';
        } else {
            completionText.textContent = `${totalFields - completedFields} fields remaining`;
            statusIndicator.className = 'status-indicator incomplete';
        }
    }
}

// Enhanced button event handlers
document.addEventListener('DOMContentLoaded', function() {
    // Preview button
    const previewBtn = document.getElementById('previewBtn');
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            // Show preview modal with current form data
            showPreview();
        });
    }
    
    // Delete button
    const deleteBtn = document.getElementById('deleteBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            showDelete();
        });
    }
    
    // Form submission with loading state
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('editMenuItemForm');
    
    if (form && submitBtn) {
        form.addEventListener('submit', function() {
            const submitIcon = document.getElementById('submitIcon');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');
            
            // Show loading state
            submitBtn.classList.add('loading');
            if (submitIcon) submitIcon.style.display = 'none';
            if (submitSpinner) submitSpinner.classList.remove('d-none');
            if (submitText) submitText.textContent = 'Updating...';
            
            submitBtn.disabled = true;
        });
    }
});

// Fix sidebar positioning and mobile toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    // Ensure sidebar scrolls with content (no forced positioning)
    const sidebar = document.querySelector('.admin-sidebar');
    const mainContent = document.querySelector('.main-content');
    
    if (sidebar && mainContent) {
        // Ensure main content has proper margin for desktop
        if (window.innerWidth >= 768) {
            mainContent.style.marginLeft = '260px';
        }
    }
    
    // Mobile sidebar toggle functionality
    const mobileToggle = document.querySelector('.mobile-toggle');
    if (mobileToggle && sidebar) {
        mobileToggle.addEventListener('click', function() {
            sidebar.classList.toggle('show');
            this.classList.toggle('active');
        });
    }
    
    // Handle window resize for responsive sidebar
    window.addEventListener('resize', function() {
        if (sidebar && mainContent) {
            if (window.innerWidth >= 768) {
                sidebar.classList.remove('show');
                mainContent.style.marginLeft = '260px';
                if (mobileToggle) mobileToggle.classList.remove('active');
            } else {
                mainContent.style.marginLeft = '0';
            }
        }
    });
    
    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
        if (window.innerWidth < 768 && sidebar && sidebar.classList.contains('show')) {
            if (!sidebar.contains(e.target) && !mobileToggle.contains(e.target)) {
                sidebar.classList.remove('show');
                if (mobileToggle) mobileToggle.classList.remove('active');
            }
        }
    });
});

// Show preview modal with current form data
function showPreview() {
    const form = document.getElementById('editMenuItemForm');
    if (!form) return;
    
    // Get form data
    const formData = new FormData(form);
    const name = formData.get('name') || 'Menu Item';
    const price = formData.get('price') || '0.00';
    const description = formData.get('description') || 'No description available';
    const category = document.getElementById('category_id')?.selectedOptions[0]?.text || 'No Category';
    
    // Update preview modal content
    const previewTitle = document.querySelector('#previewModal .preview-title');
    const previewPrice = document.querySelector('#previewModal .preview-price');
    const previewDescription = document.querySelector('#previewModal .preview-description');
    const previewCategory = document.querySelector('#previewModal .preview-category');
    
    if (previewTitle) previewTitle.textContent = name;
    if (previewPrice) previewPrice.textContent = `${price} EGP`;
    if (previewDescription) previewDescription.textContent = description;
    if (previewCategory) previewCategory.textContent = category;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}
</script>

<!-- Fix for image loading issues -->
<style>
/* Ensure proper image display */
.preview-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    object-position: center;
    border-radius: 12px;
    background: #f3f4f6;
    display: block;
}

.current-image img,
.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
}

/* Fix for missing image URLs */
.current-image img[src=""] {
    display: none;
}

.current-image img[src=""]:after {
    content: "Image not found";
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    background: #f3f4f6;
    color: #6b7280;
    font-size: 14px;
}
</style>
{% endblock %}
