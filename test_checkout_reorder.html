<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Checkout and Reorder Functions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h1>üß™ Test Checkout and Reorder Functions</h1>
                <p class="lead">This page tests the fixed checkout and reorder functionality.</p>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>Test Instructions</h3>
                    </div>
                    <div class="card-body">
                        <ol>
                            <li>Make sure you're logged in as a customer</li>
                            <li>Go to your orders page: <a href="/customer/orders" target="_blank">/customer/orders</a></li>
                            <li>Try clicking the "Pay Now" button on an unpaid order</li>
                            <li>Try clicking the "Reorder" button on a completed order</li>
                            <li>Check if the cart modal opens after reorder</li>
                        </ol>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h3>Manual API Tests</h3>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-3" onclick="testReorderAPI()">Test Reorder API</button>
                        <button class="btn btn-info mb-3" onclick="testCheckoutPage()">Test Checkout Page</button>
                        <div id="testResults" class="mt-3"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Key Fixes Applied</h3>
                    </div>
                    <div class="card-body">
                        <ul>
                            <li>‚úÖ Fixed cart modal reference (cartModal ‚Üí openCartModal() function)</li>
                            <li>‚úÖ Fixed checkout template order ID reference (order.id ‚Üí order.order_id)</li>
                            <li>‚úÖ Fixed QR routes method calls (is_admin ‚Üí is_admin())</li>
                            <li>‚úÖ Verified reorder-to-cart route exists and works</li>
                            <li>‚úÖ Updated "Total Spent" stat to only count completed orders</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('testResults');
            const alertClass = type === 'error' ? 'alert-danger' : 
                             type === 'success' ? 'alert-success' : 'alert-info';
            results.innerHTML += `<div class="alert ${alertClass}">${message}</div>`;
        }

        async function testReorderAPI() {
            log('üîç Testing reorder API...', 'info');
            
            try {
                // First get orders to find a test order
                const ordersResponse = await fetch('/customer/orders');
                if (!ordersResponse.ok) {
                    log('‚ùå Failed to load orders page. Make sure you\'re logged in.', 'error');
                    return;
                }
                
                const ordersHTML = await ordersResponse.text();
                
                // Look for order IDs in the reorder buttons
                const reorderMatches = ordersHTML.match(/reorderItems\('(\d+)'\)/g);
                if (!reorderMatches) {
                    log('‚ùå No reorderable orders found', 'error');
                    return;
                }
                
                // Extract first order ID
                const orderId = reorderMatches[0].match(/\d+/)[0];
                log(`üìã Testing reorder for order ${orderId}...`, 'info');
                
                // Test the reorder API
                const response = await fetch(`/customer/order/${orderId}/reorder-to-cart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        log(`‚úÖ Reorder API works! ${result.items_added} items added to cart.`, 'success');
                    } else {
                        log(`‚ùå Reorder failed: ${result.message}`, 'error');
                    }
                } else {
                    log(`‚ùå Reorder API failed with status: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error testing reorder API: ${error.message}`, 'error');
            }
        }

        async function testCheckoutPage() {
            log('üîç Testing checkout page...', 'info');
            
            try {
                // First get orders to find a test order
                const ordersResponse = await fetch('/customer/orders');
                if (!ordersResponse.ok) {
                    log('‚ùå Failed to load orders page. Make sure you\'re logged in.', 'error');
                    return;
                }
                
                const ordersHTML = await ordersResponse.text();
                
                // Look for checkout links
                const checkoutMatches = ordersHTML.match(/\/payment\/checkout\/(\d+)/g);
                if (!checkoutMatches) {
                    log('‚ùå No orders with checkout links found', 'error');
                    return;
                }
                
                // Extract first order ID
                const orderId = checkoutMatches[0].match(/\d+/)[0];
                log(`üí≥ Testing checkout page for order ${orderId}...`, 'info');
                
                // Test the checkout page
                const response = await fetch(`/payment/checkout/${orderId}`);
                
                if (response.ok) {
                    log('‚úÖ Checkout page loads successfully!', 'success');
                    log('üîó <a href="/payment/checkout/' + orderId + '" target="_blank">Open checkout page</a>', 'info');
                } else {
                    log(`‚ùå Checkout page failed with status: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error testing checkout page: ${error.message}`, 'error');
            }
        }

        // Show notification function (same as in customer orders)
        function showNotification(title, message, type) {
            const alertClass = type === 'danger' ? 'alert-danger' : 
                             type === 'success' ? 'alert-success' : 'alert-info';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                <strong>${title}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Auto-run basic tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Page loaded. Ready to test functionality!', 'success');
        });
    </script>
</body>
</html>
